
# Practical Exercise: Setting Up and Configuring a Firewall on Raspberry Pi

## Objective
To learn how to install, configure, and manipulate firewall rules on a Raspberry Pi using the Uncomplicated Firewall (UFW), and to use `tcpdump` and Wireshark to capture and analyze network traffic directly on the Raspberry Pi.

## Materials Needed
- Raspberry Pi (Model 3 or 4 recommended)
- MicroSD card (16GB or larger) with Raspbian OS installed
- Power supply for Raspberry Pi
- HDMI cable and monitor (or a laptop with VNC viewer for remote access)
- Keyboard and mouse
- Ethernet cable or Wi-Fi dongle (if not using built-in Wi-Fi)

## Introduction to Firewalls

A firewall is a network security device that monitors and controls incoming and outgoing network traffic based on predetermined security rules. It establishes a barrier between a trusted internal network and untrusted external networks, such as the internet. Firewalls can be hardware-based, software-based, or a combination of both. They are essential for protecting networks from unauthorized access and various cyber threats.

## What is UFW?

UFW, or Uncomplicated Firewall, is a user-friendly interface for managing iptables firewall rules on Linux systems. It is designed to simplify the process of configuring a firewall by providing straightforward command-line commands and default policies that can be easily modified to suit specific needs. UFW can be used to:

- Allow or deny traffic based on ports, IP addresses, and protocols
- Set default policies for incoming and outgoing traffic
- Enable or disable the firewall
- Reset firewall rules to default settings

## Getting the Raspberry Pi IP Address

To configure the firewall and test network connections, you need to know the IP address of your Raspberry Pi. Follow these steps to find it:

1. **Using the command line:**
   Open a terminal on your Raspberry Pi and type the following command:
   ```bash
   hostname -I
   ```
   This command will display the IP address of your Raspberry Pi.

2. **Using the router's web interface:**
   Log in to your router's web interface and check the connected devices list to find the IP address assigned to your Raspberry Pi.

## Installing and Configuring UFW

1. **Update the package list and install UFW:**
   ```bash
   sudo apt update
   sudo apt install ufw
   ```

2. **Enable UFW:**
   ```bash
   sudo ufw enable
   ```

3. **Allow SSH connections (necessary to maintain remote access):**
   ```bash
   sudo ufw allow ssh
   ```

4. **Add rules to allow specific traffic:**
   ```bash
   sudo ufw allow from 127.0.0.1 to any port 80
   sudo ufw allow from 127.0.0.1 to any port 443
   sudo ufw allow from 127.0.0.1 to any port 22
   ```

5. **Set default policies:**
   ```bash
   sudo ufw default deny incoming
   sudo ufw default allow outgoing
   ```

6. **Verify the rules:**
   ```bash
   sudo ufw status verbose
   ```

## Exercise: Modifying and Deleting Firewall Rules

Learn how to modify existing rules and delete them if necessary.

1. **Delete a Rule:**
   Identify the rule number for HTTP and delete it.
   ```bash
   sudo ufw status numbered
   sudo ufw delete <rule_number>
   ```

2. **Modify a Rule:**
   Modify the SSH rule to allow access from another IP.
   ```bash
   sudo ufw delete allow from 127.0.0.1 to any port 22
   sudo ufw allow from 192.168.1.100 to any port 22
   ```

## Testing the Firewall Rules

To test the firewall rules, you can use a simple Python script to generate traffic and verify the rules using `nmap`.

**Python Script to Generate Traffic:**
```python
import socket

def generate_traffic(port):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    try:
        s.connect(("127.0.0.1", port))
        print(f"Port {port} is open")
    except Exception as e:
        print(f"Port {port} is closed or blocked")
    finally:
        s.close()

ports_to_test = [22, 80, 443, 23]
for port in ports_to_test:
    generate_traffic(port)
```
Run this script on the Raspberry Pi to test the configured firewall rules.

**Using Nmap to Verify Rules:**
```bash
nmap -p 22,80,443,23 127.0.0.1
```
This command will scan the specified ports on the local machine and show which ones are open or closed.

## Using `tcpdump` and Wireshark to Capture and Analyze Network Traffic

### Installing `tcpdump` and Wireshark

1. **Update the package list and install `tcpdump`:**
   ```bash
   sudo apt update
   sudo apt install tcpdump
   ```

2. **Install Wireshark:**
   ```bash
   sudo apt install wireshark
   ```
   During installation, it will ask whether non-superusers should be able to capture packets. Select "Yes".

### Capturing Traffic with `tcpdump`

1. **Capture traffic on a specific interface:**
   ```bash
   sudo tcpdump -i eth0 -w capture.pcap
   ```
   This command captures all traffic on the `eth0` interface and writes it to a file named `capture.pcap`. Replace `eth0` with `wlan0` if you are using Wi-Fi.

2. **Capture traffic on a specific port:**
   ```bash
   sudo tcpdump -i eth0 port 80 -w http_traffic.pcap
   ```
   This command captures only HTTP traffic (port 80) on the `eth0` interface and writes it to a file named `http_traffic.pcap`.

3. **Stop the capture:**
   Press `Ctrl+C` in the terminal to stop the capture.

### Analyzing Captured Traffic with Wireshark

1. **Open Wireshark on the Raspberry Pi:**
   Launch Wireshark from the terminal:
   ```bash
   sudo wireshark
   ```

2. **Open the capture file in Wireshark:**
   In Wireshark, open the `.pcap` file to analyze the captured traffic.

## Exercise: Capturing and Analyzing Network Traffic

1. **Capture all traffic for a period of 1 minute:**
   ```bash
   sudo tcpdump -i eth0 -w capture_1min.pcap
   ```
   Run this command for one minute and then stop the capture with `Ctrl+C`.

2. **Capture traffic on a specific port (e.g., SSH):**
   ```bash
   sudo tcpdump -i eth0 port 22 -w ssh_traffic.pcap
   ```
   Run this command while establishing an SSH connection to your Raspberry Pi.

3. **Analyze the captured files with Wireshark:**
   Open Wireshark and load the captured files (`capture_1min.pcap` and `ssh_traffic.pcap`) for analysis.

## Conclusion and Q&A

- Recap the exercises.
- Discuss any challenges faced during the exercises.
- Answer questions from the participants.

## Additional Resources
- Official Raspberry Pi documentation: [raspberrypi.org/documentation](https://www.raspberrypi.org/documentation/)
- Wireshark documentation: [wireshark.org/docs](https://www.wireshark.org/docs/)
